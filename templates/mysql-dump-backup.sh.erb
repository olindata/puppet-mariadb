#!/bin/bash
###########################################################
# PUPPET MANAGED                                          #
# Do not edit this file on a server node unless you       #
# are willing to have your changes overwritten by         #
# Puppet.  If you really want to change the contents      #
# repository and check it out on the puppet server.          #
###########################################################

# Load common settings.

. /etc/mysql_backup.conf

# Dump the mysql databases to a daily dump file.
function syslog()
{
	logger -i -p daemon.info -t mysqldump "$1"
}

syslog "Starting database dump run"

# Empty the target dir.
#
/bin/mkdir -p ${DUMP_DIR}
/bin/rm -f ${DUMP_DIR}/*

# Get a re-useable list of databases.
DATABASES="$(mysql -u ${MYSQL_USER} -p${MYSQL_PASS} -h${MYSQL_HOST} -B -s -e 'show databases')"

# Dump mysql tables.
#
for db in ${DATABASES}; do
        if [ "z${db}" != "zinformation_schema" ]; then
                echo -n "Dumping database '${db}'...";
                /usr/bin/ionice -c3 /usr/bin/mysqldump -u ${MYSQL_USER} -p${MYSQL_PASS} -h${MYSQL_HOST} --single-transaction --triggers --quick --routines --master-data=2 --result-file "${DUMP_DIR}/${db}.sql" --databases "${db}";
                echo " ok."

                echo -n "Dumping database definitions '${db}'...";
                /usr/bin/ionice -c3 /usr/bin/mysqldump -u ${MYSQL_USER} -p${MYSQL_PASS} -h${MYSQL_HOST} --no-data --single-transaction --triggers --quick --routines --master-data=2 --result-file "${DUMP_DIR}/${db}.frm.sql" --databases "${db}";
                echo " ok."
        fi
done

syslog "Completed database dump run"
syslog "Starting dump compression run"

# Do a compression run.
# Note: do not compress the archive as a whole so it is easier to retrieve individual backups
for db in ${DATABASES}; do
        # If the database dump exists, compress it.
        #
        echo -n "Compressing ${db}.sql";
        if [ -f "${DUMP_DIR}/${db}.sql" ]; then
                /bin/gzip "${DUMP_DIR}/${db}.sql";
        fi
        echo -n " ${db}.frm.sql";
        if [ -f "${DUMP_DIR}/${db}.frm.sql" ]; then
                /bin/gzip "${DUMP_DIR}/${db}.frm.sql";
        fi
        echo " ok."
done

	

syslog "Completed dump compression run"
